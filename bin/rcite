#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'processor'
require 'style'
require 'style_helpers'
require 'slop'

def cite(id)
  load_data
  @pro.cite(id)
end

def bib(id)
  load_data
  @pro.bib(id)
end

def load_data
  @pro = ::RCite::Processor.new
  @pro.load_style($opts[:style])
  @pro.load_data($opts[:bib])
end

def main
  slop = Slop.new :help => true
  slop.command :bib do
    on :s, :style, 'path to the style file', true
    on :b, :bib, 'path to the BibTeX file', true 

    execute do |opts,args|
      check_req_opts(opts)
      $opts = opts
      puts bib(args[0])
    end
  end

  slop.command :cite do
    on :s, :style, 'path to the style file', true, :optional => false 
    on :b, :bib, 'path to the BibTeX file', true, :optional => false

    execute do |opts,args|
      check_req_opts(opts)
      $opts = opts
      puts cite(args[0])
    end
  end

  slop.parse
end

def check_req_opts(opts)
  raise "Please submit a style file using -s|--style." unless opts.style?
  raise "Please submit a bibliography file using -b|--bib" unless opts.bib?
end

if __FILE__ == $0
  main
end
